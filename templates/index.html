{% extends "layout.html" %}

{% block title %}Welcome{% endblock title %}

{% block content %}

<div class="flash-container position-absolute top-0 start-50 translate-middle-x p-3" style="z-index: 1050;">
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
      {% for category, message in messages %}
      <div class="alert alert-{{ category }} fade show shadow" role="alert" style="opacity: 1; transition: opacity 0.5s;">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
  {% endif %}
  {% endwith %}
</div>

<div class="container vh-100 mb-5">
  <div class="container-fluid" id="hiddenContent" style="display: none; height: 65%;">
    <!-- Add your hidden content here -->
  </div>
  <div class="container-fluid" id="content" style="margin-top: 170px; padding-right: 150px;">
    <h1 class="display-4 text-center mb-4"  id="header" style="font-weight: 500; font-size: 30px;">What can I help with?</h1>
    <div class="container pt-2" style="min-height: 110px; width: 90%; border-style: none;
                  border-radius: 25px; background-color: rgb(240, 242, 242);">
      <form id="messageForm">
        <div class="mb-1">
          <textarea class="form-control" id="exampleFormControlTextarea1" rows="1"
            style="background-color: rgb(240, 242, 242); border-style: none;" placeholder="Message" required></textarea>
        </div>
        <div class="d-flex flex-row-reverse">
          <button type="submit" class="btn btn-secondary" id="askButton">Ask</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log("Document loaded");

    const contentDiv = document.getElementById('hiddenContent');
    const chatDiv = document.getElementById('content');
    const header = document.getElementById('header');
    const askButton = document.getElementById('askButton');
    const textarea = document.getElementById('exampleFormControlTextarea1');

    // Check localStorage to persist the visibility state
    if (localStorage.getItem('contentVisible') === 'true') {
      contentDiv.style.display = 'block';
      const storedMessage = localStorage.getItem('message');
      const storedResponse = localStorage.getItem('response');
      if (storedMessage && storedResponse) {
        contentDiv.innerHTML = `
          <div><strong>User:</strong> ${storedMessage}</div>
          <div><strong>Response:</strong> ${storedResponse}</div>
        `;
      }
      header.style.display = 'none';
      chatDiv.style.marginTop = '10px';
    }

    // Add event listener to the form submission
    const messageForm = document.getElementById('messageForm');
    messageForm.addEventListener('submit', function (event) {
      event.preventDefault(); // Prevent the default form submission
      const message = textarea.value.trim();
      if (!message) {
        textarea.focus();
        return;
      }
      textarea.value = "";
      // Display the user's message immediately
      contentDiv.innerHTML = `<div><strong>User:</strong> ${message}</div>`;
      contentDiv.style.display = 'block';
      header.style.display = 'none';
      chatDiv.style.marginTop = '10px';
      
      // Store the message in localStorage
      localStorage.setItem('contentVisible', 'true');
      localStorage.setItem('message', message);

      // Send the message to the Flask backend
      fetch("/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ message: message })
      })
      .then(response => response.json())
      .then(data => {
        if (data.response) {
          // After getting the response, display both the message and response
          contentDiv.innerHTML += `<div><strong>Response:</strong> ${data.response}</div>`;
          localStorage.setItem('response', data.response); // Store the response in localStorage
        } else {
          contentDiv.innerHTML += `<div>Error: ${data.error}</div>`;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        contentDiv.innerHTML += "<div>An error occurred. Please try again.</div>";
      });
    });
  });
</script>
{% endblock content %}
